#!/usr/bin/env python3
from fontFeatures.feeLib import FeeParser
from fontFeatures.optimizer import Optimizer
from fontFeatures.ttLib import unparse
from fontTools.ttLib import TTFont
import sys
import argparse
import os
import warnings

parser = argparse.ArgumentParser(description='Process some integers.')
parser.add_argument('--load', action='store_true',
                    help='Load features from font file')
parser.add_argument('-O', nargs='?', const=1, type=int, default=1,
                    help='Optimization level')
parser.add_argument("--master",
                    help="Master name for .glyphs fonts", metavar="MASTER")

parser.add_argument("font",
                    help="Font file (.otf/.glyphs) to process", metavar="FONT")
parser.add_argument("fee",
                    help="FEE file to process", metavar="FEE")

args = parser.parse_args()

if args.font.endswith("tf"):
	font = TTFont(args.font)
	if args.load:
		p.fontfeatures = unparse(font)
elif args.font.endswith(".glyphs"):
	from glyphsLib import GSFont

	gsfont = GSFont(args.font)
	if args.master:
		potential_masters = list(filter(lambda x: x.name == args.master, f.masters))
		if len(potential_masters) != 1:
			warnings.warn("Could not find master '%s'" % args.master)
	else:
		font = gsfont.masters[0]
		if len(gsfont.masters) > 1:
			warnings.warn("Multiple masters in file and --master not specified, selecting '%s'" % font.name)

p = FeeParser(font)
p.parseFile(args.fee)
Optimizer(p.fontfeatures).optimize(level=args.O)
print(p.fontfeatures.asFea())
if p.font_modified:
	modified = "modified-%s" % os.path.basename(args.font)
	p.font.save(modified)
	warnings.warn("Modified font written on %s" % modified)

